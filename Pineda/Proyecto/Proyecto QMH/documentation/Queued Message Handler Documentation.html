<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
<title>Queued Message Handler</title>
<style type="text/css">
/***************************************************/
/* MINIMAL STYLES */
/* The following section defines styles that every HTML Help project should need. */

/* Specifies White Background color */
body {background-color:#ffffff}


.picture { background-color: #F9F9F9; 
border: 1px solid #CCCCCC; padding: 3px; 
font: 11px/1.4em Verdana, sans-serif; }
.picture img { border: 1px solid #CCCCCC; 
vertical-align:middle; margin-bottom: 3px; } 
.right { margin: 0.5em 0pt 0.5em 0.8em; float:right; } 
.left { margin: 0.5em 0.8em 0.5em 0; float:left; } 



/* The default style of P is red to alert you that you need to apply a style class, such as Body. */
P { margin-top:6.00pt; margin-bottom:6.00pt; font-family:Verdana; font-size:8pt; color: #000000; }

BR { font-size:4.00pt; }

H1,H2,H3,H4,H5,H6 { color:#000000 }

/* Use H1 for all topic headings. */
H1 { margin-top:3.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:12pt; font-weight:bold;  }

/* Use H2 for second-level headings. */
H2 { margin-top:9.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:10pt; font-weight:bold;  }

/* Use H3 for third-level headings. */
H3 { margin-top:6.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; font-weight:bold;  }

/* Use H4 for fourth-level headings. */
H4 { margin-top:3.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; font-weight:bold;  }

/* H5 and H6 have the same definition as H4 because you should not need this level of heading in one topic. If you need to use H5 or H6, consider breaking up your topic into more than one topic. */
H5 { margin-top:3.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; font-weight:bold;  }
H6 { margin-top:3.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; font-weight:bold;  }

/* Use the Body style class for normal paragraphs. */
P.Body { margin-top:6.00pt; margin-bottom:6.00pt; font-family:Verdana; font-size:8pt; color:#000000;  }

/* Use the Anchor style class for graphic references on a line by themselves. */
P.Anchor { margin-top:6.00pt; margin-bottom:6.00pt; font-family:Verdana; font-size:10pt; color:#000000;  }

/* Use the Indent style classes to indent a paragraph. If you need to indent text below a list item, use <br><br> to start the new paragraph within the same set of <li></li> tags. If you need to indent a list within another list, nest the indented list within the first list's set of <ol></ol> or <ul></ul> tags. */
P.Indent1 { margin-left:12.00pt; margin-top:6.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; color:#000000;  }
P.Indent2 { margin-left:24.00pt; margin-top:6.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; color:#000000;  }
P.Indent3 { margin-left:36.00pt; margin-top:6.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; color:#000000;  }

/* Use the LI style for all list items. */
LI { margin-top:3.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; color:#000000; }



/* Use the OL style for numbered lists. You do not have to type the number for each list item in a numbered list. */
OL { margin-left:18.00pt; margin-top:3.00pt; margin-bottom:3.00pt; text-indent:0pt; font-family:Verdana; font-size:8pt; color:#000000; list-style-type: decimal; }

/* Use the OL style for numbered lists. Nested lists will use the bullet types according to the nesting scheme below */
ol ol {list-style-type:lower-alpha}
ol ol ol {list-style-type:decimal}
ol ol ol ol {list-style-type:lower-alpha}
ol ol ol ol ol {list-style-type:decimal}
ol ol ol ol ol ol {list-style-type:lower-alpha}
ol ol ol ol ol ol ol {list-style-type:decimal}
ol ol ol ol ol ol ol ol {list-style-type:lower-alpha}


/* Use the EquationNum style class for numbered lists of equations. You do not have to type the number for each list item in a numbered list. */
OL.EquationNum { margin-left:36.00pt; margin-top:3.00pt; margin-bottom:3.00pt; text-indent:0pt; font-family:Verdana; font-size:8pt; color:#000000; list-style-type: decimal; }

/* Use the List-abc style class for lettered lists. You do not have to type the letter for each list item in a lettered list. */
OL.List-abc { margin-left:18.00pt; margin-top:3.00pt; margin-bottom:3.00pt; text-indent:0pt; font-family:Verdana; font-size:8pt; color:#000000; list-style-type:lower-alpha; }

/* Use the UL style for bulleted lists. You do not have to type the bullet for each list item in a bulleted list. */
UL { margin-left:12.00pt; text-indent:0pt; margin-top:3.00pt; margin-bottom:3.00pt; font-family:Verdana; font-size:8pt; color:#000000;}

/* Use the List-Box style class for bulleted lists with boxes instead of bullets. You do not have to type the box for each list item in a box list. */
UL.List-Box { margin-left:12.00pt; margin-top:3.00pt; margin-bottom:3.00pt; text-indent:0pt; font-family:Verdana; font-size:8pt; color:#000000; list-style-type: square; }

/* Use the Platform format to denote a specific platform. */
.Platform { color: #0000FF; font-weight: bold; }

/* Use the Borderless style class for tables that do not need borders, such as for 2-column or 3-column lists with no headings. */
Table.Borderless { border:none; }

/* Use the Bordered style class for tables that need borders. */
Table.Bordered { border-width: 1pt; border-style: solid; border-color: #000000; border-collapse: collapse; }

/* Use the Borderless-Wide style class for tables that do not need borders and that you want to stretch to fill the entire topic width. */
Table.Borderless-Wide { border:none; width:100%; }

/* Use the Bordered-Wide style class for tables that need borders and that you want to stretch to fill the entire topic width. */
Table.Bordered-Wide { border-width: 1pt; border-style: solid; border-color: #000000; width:100%; border-collapse: collapse; }

/* Use the TD style for table cells in Borderless or Borderless-Wide tables. */
TD { font-family:Verdana; font-size:8pt; color:#000000; vertical-align:top; padding:3px; }

/* Use the Bordered style class for table cells in Bordered or Bordered-Wide tables. */
TD.Bordered { font-family:Verdana; font-size:8pt; color:#000000; vertical-align:top; border-width: 1pt; border-style: solid; border-color: #000000; }

/* Use the Icon style class for table cells that contain note, caution, warning, or tip icons, or LabVIEW datatype terminals. */
TD.Icon { width:40px; vertical-align:top; }

/* Use the Table-cell-8pt style class for table cells in tables that contain a lot of information and need smaller text to fit it all on one screen to prevent a horizontal scroll bar from appearing. */
TD.Table-cell-8pt { font-family:Verdana; font-size:7pt; color:#000000;  }

/* Use the TH style for table heading cells in Borderless or Borderless-Wide tables. */
TH { font-family:Verdana; font-size:8pt; color:#000000; font-weight:bold; padding:3px; }

/* Use the Bordered style class for table heading cells in Bordered or Bordered-Wide tables. */
TH.Bordered { font-family:Verdana; font-size:8pt; color:#000000; font-weight:bold;  border-width: 1pt; border-style: solid; border-color: #000000; }

/* Use the Table-cell-8pt style class for table heading cells in tables that contain a lot of information and need smaller text to fit it all on one screen to prevent a horizontal scroll bar from appearing. */
TH.Table-Head-8pt { font-family:Verdana; font-size:7pt; color:#000000; font-weight:bold; }

/* Use the Left-Align style class for table heading cells that you want to left align instead of center align. */
TH.Left-Align { font-family:Verdana; font-size:8pt; color:#000000; font-weight:bold; padding:3px; text-align:left; }

/***************************************************/
/* CHARACTER FORMATS */
/* The following section defines character formats that every HTML Help project should need. */

/* Use the Dark-Red format for warnings or cautions. */
#Dark-Red { color: #800000 }

/* Use the Monospace format for code or syntax examples. */
#Monospace { font-family: "Courier New"; font-size: 8pt; }

/* Use the Monospace-Bold format for messages and responses that the computer automatically prints to the screen. */
#Monospace-Bold { font-family: "Courier New"; font-size: 8pt; font-weight: bold; }

/* Use the Monospace-Italic format to denote text that is a placeholder for a word or value that the user must supply. */
#Monospace-Italic { font-family: "Courier New"; font-size: 8pt; font-style: italic; }

/* Use the Symbol format for characters not in the Verdana character set. Use this format sparingly. When possible, you should use the correct ASCII code for the symbol or use a graphic to recreate the symbol. */
#Symbol { font-family: Symbol; font-size: 8pt; }

/* The following styles define the color of links. */
a:link { color: #007700 }
a:hover { color: #FF0000 }
a:active { color: #FF0000 }
a:visited { color: #7F007F }

/***************************************************/
/* ACTIVITY STYLES */
/* The following section defines styles that only tutorial-style HTML Help projects should need. */

/* Use the Activity-Objective style class for the objective at the beginning of an activity topic. */
H3.Activity-Objective { color: #800000; }

/***************************************************/
/* CODE STYLES */
/* The following section defines styles that you need to format entire sections of code or syntax examples. If you have just a few words you need to format as a code or syntax example, use the Monospace character format. */

P.Code { margin-top:3.00pt; margin-bottom:0.00pt; font-family:"Courier New"; font-size:8pt; color:#000000;  }
P.Code1 { margin-left:12.00pt; margin-top:3.00pt; margin-bottom:0.00pt; font-family:"Courier New"; font-size:8pt; color:#000000;  }
P.Code2 { margin-left:24.00pt; margin-top:3.00pt; margin-bottom:0.00pt; font-family:"Courier New"; font-size:8pt; color:#000000;  }
P.Code3 { margin-left:36.00pt; margin-top:3.00pt; margin-bottom:0.00pt; font-family:"Courier New"; font-size:8pt; color:#000000;  }

/***************************************************/
/* FUNCTION STYLES */
/* The following section defines styles that you might need to format function reference help. */

P.F-VI-Code4 { margin-left:48.00pt; margin-top:3.00pt; margin-bottom:0.00pt; font-family:"Courier New"; font-size:8pt; color:#000000;  }
P.F-VI-Code5 { margin-left:60.00pt; margin-top:3.00pt; margin-bottom:0.00pt; font-family:"Courier New"; font-size:8pt; color:#000000;  }
P.F-VI-Equation { margin-top:9.00pt; margin-bottom:9.00pt; font-family:Verdana; font-size:8pt; color:#000000;  }

OL.F-VI-EquationNum { margin-top:3.00pt; margin-bottom:3.00pt; text-indent:0pt; font-family:Verdana; font-size:8pt; color:#000000; list-style-type: decimal; }
</style>
</HEAD>
<body>

<h1>Queued Message Handler</h1>

<p class="Body">LabVIEW 2011</p>

<p class="Body">The Queued Message Handler (QMH) template provides a framework for connecting a user interface with appropriate portions of code. The framework is similar to that of a state machine and provides for parallel tasks, loops that communicate with each other, and persistent state data.</p>

<p class="Body">This template is based on the Producer/Consumer design pattern.</p>

<p class="Body">Use the QMH template in the following types of applications:</p>
<ul>
	<li>Multi-page dialog boxes similar to the <strong>Options</strong> dialog box in LabVIEW.</li>
	<li>Continuously acquiring measurements while performing other tasks such as data logging.</li>
	<li>Applications where tasks need to run in parallel but also communicate with one another.</li>
</ul>

<a name="requirements"></a><h1>Requirements</h1>
<p class="Body">LabVIEW 2012 Base, Full, or Professional Edition</p>

<a name="design_implementation"></a><h1>Design and Implementation</h1>
<p class="Body">The following sections describe the major features of this template and how each feature is implemented.</p>

<a name="design_overview"></a><h2>Design Overview</h2>
<p class="Body">The QMH template is divided into three main portions:</p>
<ul>
	<li><strong>Event Handling Loop</strong>&#8212;Reacts to user interface changes, such as a user clicking a button, and adds a message to the message queue.</li>
	<li><strong>Message Queue</strong>&#8212;Stores messages for future action.</li>
	<li><strong>Message Handling Loop</strong>&#8212;Acts on messages in the order in which they were added to the queue.</li>
</ul>

<a name="features"></a><h2>Major Features and Implementation Decisions</h2>
<p class="Body">The following sections describe how major features of this template are implemented.</p>

<h3>Startup Initialization Routines</h3>
<h4>Motivation</h4>
<p class="Body">Many applications need to run initialization routines to prevent unwanted behavior. Common initialization routines can include:</p>
<ul>
	<li>Ensuring arrays used for data storage are empty</li>
	<li>Opening references to hardware being used</li>
	<li>Opening files on disk for data logging</li>
</ul>
<p class="Body">The application should be designed so that initialization routines are the first to run.</p>
<h4>Implementation</h4>
<ul>
	<li>The creation of the message queue with the 'Initialize' message in it</li>
	<li>The 'Initialize' subdiagram of the Case structure in the Message Handling Loop</li>
	<li>Registering a user event for the <strong>Stop</strong> button</li>
</ul>
<h4>Rationale</h4>

<h3>Responsive User Interface</h3>
<h4>Motivation</h4>
<p class="Body">A responsive user interface initiates actions based on user input and includes a method for ensuring user input is not discarded.</p>
<h4>Implementation</h4>
<ul>
	<li>Parallel While Loops
		<ul>
			<li>Code execution that occurs in one loop does not interrupt code in the other</li>
			<li>Can add or remove consumer loops without too much impact on the rest of the application</li>
		</ul>
	</li>
	<li>An Event structure in the Event Handling Loop
		<ul>
			<li>The Event structure removes the need to constantly poll the front panel for UI changes, improving CPU efficiency</li>
			<li>The Event structure provides a framework for adding front panel controls, making the template easier to customize</li>
		</ul>
	</li>
	<li>Messages are strings.
		<ul>
			<li>Strings are words, which convey meaning better than numbers do.</li>
			<li>Creating new strings requires less work than modifying a type definition.</li>
		</ul>		
	</li>
	<li>Messages are stored in a queue.
		<ul>
			<li>A queue stores messages while other code is running.</li>
			<li>Queues operate in a first-in, first-out (FIFO) manner, which means older messages are processed before newer ones. This design matches how we think of message processing.</li>
		</ul>
	
	</li>
</ul>

<h3>Message Handling</h3>
<h4>Motivation</h4>
<p class="body">Portions of code should execute only when triggered by a specific message.</p>
<h4>Implementation</h4>
<p class="Body">A While Loop, labeled <strong>Message Handling Loop</strong>, that contains a Case structure. The While Loop reads the oldest message from the message queue. Each message triggers a different subdiagram of the Case structure.</p>

<h3>Sending Priority Messages</h3>
<h4>Motivation</h4>
<p class="body">Sometimes code needs to be run immediately, for example, loops need to shut down in the event of an error. However, the FIFO nature of the queue means that new messages are placed at the end of the queue.</p>
<h4>Implementation</h4>
<p class="body">You can send a priority message by wiring <strong>TRUE</strong> to the <strong>priority</strong> input of the Enqueue Message VI. This action places the message at the beginning of the queue, so it is the next message read.</p>

<h3>Associating Data with Messages</h3>
<h4>Motivation</h4>
<p class="body">Attaching data to a message can be useful. For example, when you send the 'Acquire Data' message, you could also send the time at which this message was sent. If you send an error message, you could send the value that caused the error. However, the message itself is just a string, which cannot hold data itself.</p>
<h4>Implementation</h4>
<p class="body">The Enqueue Message VI has a <strong>Message Data</strong> input. Data that you wire to this terminal is stored in the queue alongside the message.</p>
<h4>Rationale</h4>

<h3>Multi-Rate Tasks</h3>
<h4>Motivation</h4>
<p class="Body">Not all tasks need to run at the same rate. Forcing a task to run at an unintended rate can cause errors.</p>
<h4>Implementation</h4>
<p class="Body">The parallel nature of the template means you can place each task into a loop that runs at the appropriate rate.</p>

<h3>State Data Storage</h3>
<h4>Motivation</h4>
<p class="Body">Consumers should be able to pass data to one another.</p>
<h4>Implementation</h4>
<p class="Body">An auto-updating typedef, UI Data.ctl, is wired to a shift register on the Message Handling Loop.</p>
<h4>Rationale</h4>
<ul>
	<li>You can modify the typdef to suit the needs of your application.</li>
	<li>Because the typedef updates automatically, modifying the typdef will not break any wires in the application.</li>
	<li>The shift register keeps your changes persistent by passing update data to the next iteration of the Message Handling Loop.</li>
</ul>

<h3>Each Loop Can Stop the Other</h3>
<h4>Motivation</h4>
<p class="Body">When a user stops the VI, or in some other situation you define, all producer and consumer loops need to shut down to prevent code from executing unintentionally.</p>
<h4>Implementation</h4>
<p class="Body">The Event Handling Loop can stop the Message Handling Loop by producing a priority <strong>Stop</strong> message. Before it shuts down, the Message Handling Loop fires a user event that stops the Event Handling Loop.</p>

<h3>Error Prevention and Handling</h3>
<h4>Motivation</h4>
<p class="body">Well-written software programs should account for as many situations as possible, ensure LabVIEW releases all requested resources on shutdown, and try to fail gracefully.</p>
<h4>Implementation</h4>
<ul>
	<li>All VIs' and functions' error terminals are wired through. This implementation ensures errors do not get lost as the program executes.</li>
	<li>Code in loops has its error terminals wired through shift registers. This implementation ensures errors in loops persist through to subsequent iterations.</li>
	<li>Some error terminals are wired to the selector terminals of Case structures. This implementation ensures the code inside executes only if no errors have been detected.</li>
	<li>Errors in the Event Handling Loop trigger a priority message instead of a normal message. This implementation ensures the Message Handling Loop responds immediately to any errors in the Event Handling Loop. The subsequent code path in the Message Handling Loop ensures that both loops will stop if there is an error.</li>
	<li>The Default case of the Case structure in the Message Handling Loop executes if an unrecognized message is read from the queue. This implementation prevents code from being run unintentionally. This implementation also means you do not have to create a subdiagram for every possible message.</li>
	<li>The Enqueue Message and Dequeue Message VIs wrap their respective LabVIEW functions with robust error-handling code.</li>
</ul>

<h3>Summary of LabVIEW Features Used</h3>
<ul>
	<li>Front panel controls</li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/strings/">Strings</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/while_loops_concepts/">While Loops</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/shift_registers_concepts/">Shift registers</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/glang/case_structure/">Case structures</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/custom_cont_ind_type/">Type definitions</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvhowto/variants/">Variant data</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/glang/queue_vis/">Queues</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/labview_and_hyper_threading/">Parallelism</a></li>
	<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/using_events_in_labview/">Events:</a>
		<ul>
			<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/event_structure_components/">Event structure</a></li>
			<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvprop/ctrl_value_changed/">Value change events</a></li>
			<li><a href="http://zone.ni.com/reference/en-XX/help/371361H-01/lvconcepts/user_events/#Creating_and_Registering_User_Events">User events</a></li>
		</ul>
	</li>

</ul>


</body>
</html>
